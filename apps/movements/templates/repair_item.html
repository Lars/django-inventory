{% extends "base.html" %}
{% load i18n %}
{% load styling %}
{% load generic_views_helpers %}
{% block title %}{%trans "Repair Asset" %}{% endblock %}

{% block javascript %}
<script type="text/javascript">
var date_fmt1 = /([0-3]?[0-9])\/([0-1]?[0-9])\/([0-9]{4})/; // European DD/MM/YYYY
var date_fmt2 = /([0-9]{4})-([0-1]?[0-9])-([0-3]?[0-9])/; // ISO YYYY-MM-DD

var pendingRefreshTO;

function refreshStory(){
    console.log("Refresh story!");
    var div_story = $("#story");
    div_story.find("ul").empty();

    var has_add = false;
    $("#item_target ul li:not(.hint)").each(function() {
        var item_id = this.id.replace(/^item-/,'');
        var new_li = $("<li>").text($(this).text());
        new_li.append($("<input>", {type: "hidden", name: "parts_in", value: item_id}));
        $("#story_added ul").append(new_li);
        has_add = true;
    });

    if (has_add) {
        $("#story_noitems").hide();
        $("#story_added").show();
    }
    else
        $("#story_added").hide();
    
    // list the items removed
    var has_remove = false;
    $("#story_removed h5").hide();
    $("#story_removed ul").hide();
    $("#dests div.target ul li:not(.hint)").each(function() {
            var item_id = this.id.replace(/^item-/,'');
            var loc_id = $(this).parent().get(0).id.replace(/^outbin-/,'');
            // console.log("Removed " + item_id + " into " + loc_id);
            var new_li = $("<li>").text($(this).text());
            new_li.append($("<input>", {type: "hidden", name: "parts_out", value: loc_id+":" + item_id}));
            $("#story_removed #outstory-h-"+loc_id).show();
            $("#story_removed #outstory-"+loc_id).show().append(new_li);
            has_remove = true;
        });

    if (has_remove){
        $("#story_noitems").hide();
        $("#story_removed").show();
    }
    else
        $("#story_removed").hide();

    if ( has_add || has_remove)
        $("#dsubmit").show();
    else {
        $("#dsubmit").hide();
        $("#story_noitems").show();
    }
}

function receive_items(event, ui) {
    window.clearTimeout(pendingRefreshTO);
    $(this).find("li.hint").hide();
    if ($(ui.sender).find("li:not(.hint)").length == 0)
        $(ui.sender).find("li.hint").show();
    pendingRefreshTO = window.setTimeout(refreshStory, 500);
}

$(function() {
    $( "#sources" ).accordion({ collapsible: true, heightStyle: "content" });
    $( "#dests" ).accordion({ collapsible: true });

    /* Spare Parts to item incoming direction */
    $("#item_target ul").sortable({
                        connectWith: "#sources div.source ul", 
                        opacity: 0.8, 
                        cancel:"a,input,button,.hint",
                        placeholder: "ui-state-highlight",
                        receive: receive_items,
                        }).disableSelection();
    $("#sources div.source ul").sortable({
                        connectWith: "#item_target ul",
                        opacity: 0.8,
                        cancel:"a,input,button,.hint",
                        placeholder: "ui-state-highlight",
                        receive: receive_items,
                        } ).disableSelection();

    /* Item to outgoing direction */
    $("#parts_in_item ul").sortable({
                        connectWith: "#dests div.target ul", 
                        opacity: 0.8, 
                        cancel:"a,input,button,.hint",
                        placeholder: "ui-state-highlight",
                        receive: receive_items,
                        } ).disableSelection();
    $("#dests div.target ul").sortable({
                        connectWith: "#parts_in_item ul",
                        opacity: 0.8,
                        cancel:"a,input,button,.hint",
                        placeholder: "ui-state-highlight",
                        receive: receive_items,
                        } ).disableSelection();

    /* events: out(), receive() */
  });

function validateDate(dstr) {
  /* Validate that dstr is a valid date, in European dd/mm/YYYY or YYYY-mm-dd format
 */
    var m1 = date_fmt1.exec(dstr);
    if (m1){
        var dd = new Date(m1[3],m1[2]-1, m1[1]);
        if ((dd.getDate() == m1[1]) && (dd.getMonth() + 1 == m1[2]) && (dd.getFullYear() == m[3]))
            return true;
        else {
            console.log("Input date differs: " + dd.toDateString());
        }
        return false; // don't attempt fmt2
    }
    var m2 = date_fmt2.exec(dstr);
    if (m2){
        var dd = new Date(m1[1],m1[2]-1, m1[3]);
        if ((dd.getDate() == m1[3]) && (dd.getMonth() + 1 == m1[2]) && (dd.getFullYear() == m[1]))
            return true;
        else {
            console.log("Input date differs: " + dd.toDateString());
        }
    }
    return false;
}

function validateForm(form) {
    if (!validateDate(form.issue_date.value)){
        $("#date_invalid").show();
        return false;
    }
}
</script>
{% endblock %}

{% block sidebar %}
{% endblock %}

{% block stylesheets %}
    {{ wizard.form.media }}
    <!--<link href="{{ STATIC_URL }}css/po_wizard.css" type="text/css" rel="stylesheet">-->
    <style type="text/css">
    /*-*/
    #main {
        width: 90%;
    }
    #sidebar {
        width: 10%;
    }

    #three_columns td {
        vertical-align: top;
        padding: 4px;
    }

    div.target {
        border: solid green 1px;
    }
    div.target ul, #parts_in_item ul, #item_target ul {
        min-height: 100px;
        min-width: 100px;
        padding: 6px;
    }

    ul.ui-sortable li {
        list-style: none;
    }
    ul.ui-sortable li:not(.hint)
    {
        background: #C0FFFF;
        border: solid 1px #00C0C0;
        margin-bottom: 2px;
        padding-left: 2px;
        padding-right: 2px;
    }
    ul.ui-sortable li.ui-state-highlight {
        /* the empty space as a drop target */
        height: 1.2em;
        line-height: 1.1em;
        background: #FFFFC0;
        border: solid 1px #FFA858;
    }
    ul li.hint {
        list-style: none;
        color: #b0b0b0;
        font-style: italic;
        padding: 10px;
    }
    #repair_fields td {
        vertical-align: top;
    }
    </style>
{% endblock %}

{% block content %}

<div class="content" width="90%"  >
<form action="." method="post" onsubmit="return validateForm(this)" >{% csrf_token %}
<h2>{% trans 'Repair form:' %} {{ item }}</h2>
<table id="repair_fields" width="100%">
<tr><td width="*">
    <table id="rform">
        <tr><td>{% trans 'Now at:' %}</td> <td>{{ item.location }}</td> </tr>
        <tr><td><label for="issue_date">{% trans 'Issue date:' %}</label></td>
            <td><input name="issue_date" type="text"/>
                <div id="date_invalid" style="display: none; color: red;">
                    {% trans 'You have to enter a date in DD/MM/YYY format' %}
                </div>
            </td>
        </tr>
        <tr><td><label for="user_id">{% trans 'User ID:' %}</label></td>
            <td><input name="user_id" type="text"/></td>
        </tr>
    </table>
  </td>
  <td width="*">
    <label for="notes">{% trans 'Notes' %}</label><br/>
    <textarea name="notes" style="min-height: 5em; min-width: 70%"></textarea>
  </td>
</tr>
</table>

<table id="three_columns" width="100%">
<tr><th width="33%">{% trans 'Spare parts' %}</th>
    <th width="33%">{% trans 'In Asset' %}</th>
    <th width="33%">{% trans 'Removed parts' %}</th></tr>
<tr>
    <td><div id="sources">
            {% for src, items in src_locations %}
                <h3>{{ src }}</h3>
                <div class="source"><ul>
                    {% for si in items %}
                        <li id="item-{{si.id}}" title="{%trans 'You can drag this part to the middle column' %}">{{si }}</li>
                    {% endfor %}
                </ul></div>
            {% endfor %}
        </div>
    </td>
    <td>
        <h3>{% trans 'Contains' %}</h3>
        <div id="parts_in_item">
            <ul>
            {% for part in item.itemgroup.items.all %}
                <li id="item-{{part.id}}" title="{%trans 'This part can be dragged to the right column'%}">{{ part }}</li>
            {% endfor %}
            </ul>
        </div>
        <h3>{% trans 'Add in repair' %}</h3>
        <div id="item_target" class="target">
            <ul>
                <li class="hint">{% trans 'Drag here the parts you want to add to the item.' %}</li>
            </ul>
        </div>
    </td>
    <td>
        <div id="dests">
            {% for trg in dest_locations %}
                <h3>{{ trg }}</h3>
                <div>
                    <div class="target">
                        <ul id="outbin-{{ trg.id }}" >
                            <li class="hint">{% trans 'Drag here the parts you want to remove.' %}</li>
                        </ul>
                    </div>
                </div>
            {% endfor %}
        </div>
    </td>
</tr>
</table>

<h3>{% trans "Description of movements" %}</h3>
<div id="story">
    <p id="story_noitems">{% trans "No parts have changed yet" %}</p>
    <div style="display: none" id="story_added">
        <h4>{% trans 'These parts will be added to the bundle' %}</h4>
        <ul> </ul>
    </div>
    <div style="display: none" id="story_removed">
        <h4>{% trans 'These parts will be removed from the bundle' %}</h4>
        {% for trg in dest_locations %}
                <h5 id="outstory-h-{{trg.id}}">{% trans 'To:' %} {{ trg }}</h5>
                <ul id="outstory-{{ trg.id }}" style="display: none;"> </ul>
        {% endfor %}
    </div>
</div>

<div id="dsubmit" style="display: none">
    <p>
    {%blocktrans %}If you agree with the above movements, you can now press the submit
    button and the appropriate actions will be prepared for the repair. <br/>
    After those, the repair form will still need to be validated by an authorized user.
    {% endblocktrans %}
    </p>
    <p style="text-align: left; width: 100%">
        <input type="submit" value="{% trans 'Submit' %}" />
    </p>
</form>


</div>

{% endblock %}
